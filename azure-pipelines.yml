# Get code from repo, build images, push images to container registry

trigger: none
pr: none

variables:
    vmImageName: "ubuntu-latest"

stages:
    - stage: Build
      displayName: Build and push stage
      jobs:
          - job: Build
            displayName: Build
            pool:
                vmImage: $(vmImageName)
            steps:
                - task: DockerCompose@0
                  displayName: Build Images
                  inputs:
                    containerregistrytype: 'Container Registry'
                    dockerRegistryEndpoint: '$(REGISTRY_URI)'
                    dockerComposeFile: '**/docker-compose.yml'
                    action: 'Build services'
                    includeLatestTag: true
                    arguments: '--parallel'
                
                - task: DockerCompose@0
                  inputs:
                    containerregistrytype: 'Container Registry'
                    dockerRegistryEndpoint: '$(REGISTRY_URI)'
                    dockerComposeFile: '**/docker-compose.yml'
                    action: 'Push services'
                    includeLatestTag: true

                - task: PublishPipelineArtifact@1
                  displayName: Publish Artifacts
                  inputs:
                      targetPath: "$(Build.ArtifactStagingDirectory)"
                      publishLocation: "pipeline"
                      artifact: $(Build.BuildId)
